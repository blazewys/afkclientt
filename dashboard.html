<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Minecraft AFK Client Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.05);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .afk-list {
            display: grid;
            gap: 15px;
        }

        .afk-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            transition: all 0.3s;
        }

        .afk-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .afk-item.active {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .afk-info {
            display: grid;
            gap: 10px;
        }

        .afk-info h3 {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 5px;
        }

        .afk-info p {
            color: #666;
            font-size: 0.9em;
            margin: 2px 0;
        }

        .afk-info p strong {
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-connecting {
            background: #f59e0b;
            color: white;
        }

        .status-stopped {
            background: #ef4444;
            color: white;
        }

        .afk-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .uptime {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #666;
        }

        .empty-state p {
            font-size: 1em;
        }

        /* Chat Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
            max-height: 400px;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #667eea;
            word-wrap: break-word;
        }

        .chat-message.server {
            border-left-color: #3b82f6;
        }

        .chat-message.bot {
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        .chat-message.system {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }

        .chat-message.error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }

        .chat-timestamp {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 5px;
        }

        .chat-text {
            color: #333;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .user-info {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }
            
            .afk-item {
                grid-template-columns: 1fr;
            }
            
            .afk-actions {
                flex-direction: row;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="currentUser">Y√ºkleniyor...</span>
                <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
            </div>
            <h1>ü§ñ Minecraft AFK Client Bot</h1>
            <p>Minecraft sunucularƒ±na otomatik AFK sistemi</p>
        </div>

        <!-- AFK Ekle Formu -->
        <div class="card">
            <h2>‚ûï Yeni AFK Ekle</h2>
            <form onsubmit="addAFK(event)">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="username">Kullanƒ±cƒ± Adƒ± *</label>
                        <input type="text" id="username" placeholder="Minecraft kullanƒ±cƒ± adƒ±" required>
                    </div>
                    <div class="input-group">
                        <label for="password">≈ûifre *</label>
                        <input type="password" id="password" placeholder="Minecraft ≈üifresi" required>
                    </div>
                    <div class="input-group">
                        <label for="server">Sunucu Adresi *</label>
                        <input type="text" id="server" placeholder="play.example.com" required>
                    </div>
                    <div class="input-group">
                        <label for="port">Port</label>
                        <input type="number" id="port" placeholder="25565" value="25565">
                    </div>
                    <div class="input-group">
                        <label for="version">Versiyon</label>
                        <input type="text" id="version" placeholder="1.20.1" value="1.20.1">
                    </div>
                    <div class="input-group">
                        <label for="auth">Auth Tipi</label>
                        <select id="auth">
                            <option value="offline">Offline (Cracked)</option>
                            <option value="microsoft">Microsoft</option>
                            <option value="mojang">Mojang</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="townyCommand">Towny Komutu (Opsiyonel)</label>
                        <input type="text" id="townyCommand" placeholder="/towny (varsayƒ±lan)">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full">AFK Ekle</button>
            </form>
        </div>

        <!-- AFK Listesi -->
        <div class="card">
            <h2>üìã AFK Listesi</h2>
            <div id="afkList" class="afk-list">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <h3>Y√ºkleniyor...</h3>
                </div>
            </div>
        </div>

        <!-- Discord Webhook -->
        <div class="card">
            <h2>üîó Discord Webhook Ayarlarƒ±</h2>
            <div class="input-group">
                <label for="webhookUrl">Durum Webhook URL</label>
                <input type="text" id="webhookUrl" placeholder="https://discord.com/api/webhooks/...">
                <small style="color: #666; display: block; margin-top: 5px;">Bot durumlarƒ±nƒ±n s√ºrekli g√∂sterildiƒüi embed mesajƒ± i√ßin</small>
            </div>
            <button onclick="saveWebhook()" class="btn btn-primary btn-full">Durum Webhook Kaydet</button>
            
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
            
            <div class="input-group">
                <label for="notificationWebhookUrl">Bildirim Webhook URL (@everyone)</label>
                <input type="text" id="notificationWebhookUrl" placeholder="https://discord.com/api/webhooks/...">
                <small style="color: #666; display: block; margin-top: 5px;">Botlar d√º≈üt√ºƒü√ºnde @everyone ile bildirim g√∂nderilir</small>
            </div>
            <button onclick="saveNotificationWebhook()" class="btn btn-primary btn-full">Bildirim Webhook Kaydet</button>
        </div>

        <!-- Loglar -->
        <div class="card">
            <h2>üìä Sistem Loglarƒ±</h2>
            <div id="logContainer" class="log-container">
                <div class="log-entry log-info">ü§ñ Sistem hazƒ±r...</div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chatModalTitle">üí¨ Chat</h2>
                <button class="close-modal" onclick="closeChatModal()">Kapat</button>
            </div>
            <div id="chatMessages" class="chat-messages">
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <h3>Hen√ºz mesaj yok</h3>
                    <p>Sunucudan mesajlar burada g√∂r√ºnecek</p>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Mesaj yaz..." onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()" class="send-btn">G√∂nder</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentChatAfkId = null;

        // WebSocket baƒülantƒ±sƒ±
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                addLog('WebSocket baƒülantƒ±sƒ± kuruldu', 'success');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'log') {
                        addLog(data.message, data.logType);
                    } else if (data.type === 'afk_list_updated') {
                        loadAFKs();
                    } else if (data.type === 'chat_message') {
                        handleChatMessage(data);
                    } else if (data.type === 'bot_status_update') {
                        // Tek bir bot durumu g√ºncellendi
                        handleBotStatusUpdate(data);
                    } else if (data.type === 'bot_statuses') {
                        // T√ºm bot durumlarƒ± g√ºncellendi
                        handleAllBotStatuses(data.statuses);
                    }
                } catch (error) {
                    console.error('WebSocket mesaj hatasƒ±:', error);
                }
            };

            ws.onerror = (error) => {
                addLog('WebSocket hatasƒ±!', 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                addLog('WebSocket baƒülantƒ±sƒ± kapandƒ±, yeniden baƒülanƒ±lƒ±yor...', 'warning');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const icon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå'
            }[type] || '‚ÑπÔ∏è';
            
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Maksimum 50 log tut
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('currentUser').textContent = `üë§ ${data.user.username} (${data.user.role})`;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Kullanƒ±cƒ± bilgisi y√ºklenemedi:', error);
                window.location.href = '/';
            }
        }

        async function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                try {
                    const response = await fetch('/api/logout', { method: 'POST' });
                    const data = await response.json();
                    
                    if (data.success) {
                        addLog('√áƒ±kƒ±≈ü yapƒ±lƒ±yor...', 'info');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 500);
                    }
                } catch (error) {
                    console.error('√áƒ±kƒ±≈ü hatasƒ±:', error);
                }
            }
        }

        async function loadAFKs() {
            try {
                const response = await fetch('/api/afks');
                const data = await response.json();
                
                if (data.success) {
                    renderAFKList(data.afks);
                }
            } catch (error) {
                addLog('AFK listesi y√ºklenemedi: ' + error.message, 'error');
            }
        }

        function renderAFKList(afks) {
            const afkListContainer = document.getElementById('afkList');
            
            if (afks.length === 0) {
                afkListContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ü§ñ</div>
                        <h3>Hen√ºz AFK yok</h3>
                        <p>Yukarƒ±daki formdan yeni AFK ekleyebilirsin</p>
                    </div>
                `;
                return;
            }

            afkListContainer.innerHTML = '';
            
            afks.forEach(afk => {
                const afkItem = document.createElement('div');
                afkItem.className = `afk-item ${afk.isActive ? 'active' : ''}`;
                afkItem.dataset.afkId = afk.id; // ID'yi data attribute olarak ekle
                
                let statusBadge = '';
                let uptime = '';
                
                if (afk.isActive) {
                    if (afk.status === 'connected') {
                        statusBadge = '<span class="status-badge status-active">üü¢ Aktif</span>';
                        const uptimeMs = afk.uptime;
                        const hours = Math.floor(uptimeMs / 3600000);
                        const minutes = Math.floor((uptimeMs % 3600000) / 60000);
                        const seconds = Math.floor((uptimeMs % 60000) / 1000);
                        uptime = `<span class="uptime">‚è±Ô∏è ${hours}s ${minutes}d ${seconds}s</span>`;
                    } else if (afk.status === 'connecting') {
                        statusBadge = '<span class="status-badge status-connecting">üü° Baƒülanƒ±yor</span>';
                    } else if (afk.status === 'login') {
                        statusBadge = '<span class="status-badge status-connecting">üü° Login</span>';
                    }
                } else {
                    statusBadge = '<span class="status-badge status-stopped">üî¥ Kapalƒ±</span>';
                }
                
                afkItem.innerHTML = `
                    <div class="afk-info">
                        <h3>ü§ñ ${afk.username}</h3>
                        <p><strong>Sunucu:</strong> ${afk.server}:${afk.port}</p>
                        <p><strong>Versiyon:</strong> ${afk.version}</p>
                        ${afk.townyCommand ? `<p><strong>Towny:</strong> ${afk.townyCommand}</p>` : ''}
                        <div>
                            ${statusBadge}
                            ${uptime}
                        </div>
                    </div>
                    <div class="afk-actions">
                        ${afk.isActive 
                            ? `<button class="btn btn-danger btn-small" onclick="stopAFK('${afk.id}')">Durdur</button>
                               <button class="btn btn-secondary btn-small" onclick="openChatModal('${afk.id}', '${afk.username}')">üí¨ Chat</button>` 
                            : `<button class="btn btn-primary btn-small" onclick="startAFK('${afk.id}')">Ba≈ülat</button>`
                        }
                        <button class="btn btn-warning btn-small" onclick="deleteAFK('${afk.id}', '${afk.username}')">Sil</button>
                    </div>
                `;
                
                afkListContainer.appendChild(afkItem);
            });
        }

        async function addAFK(event) {
            event.preventDefault();
            
            const afkData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                server: document.getElementById('server').value,
                port: parseInt(document.getElementById('port').value) || 25565,
                version: document.getElementById('version').value || '1.20.1',
                auth: document.getElementById('auth').value,
                townyCommand: document.getElementById('townyCommand').value
            };

            try {
                const response = await fetch('/api/afks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(afkData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(result.message, 'success');
                    // Formu temizle
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('server').value = '';
                    document.getElementById('townyCommand').value = '';
                    // Listeyi yenile
                    loadAFKs();
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('AFK ekleme hatasƒ±: ' + error.message, 'error');
            }
        }

        async function startAFK(afkId) {
            try {
                const response = await fetch(`/api/afks/${afkId}/start`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(result.message, 'success');
                    loadAFKs();
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('AFK ba≈ülatma hatasƒ±: ' + error.message, 'error');
            }
        }

        async function stopAFK(afkId) {
            try {
                const response = await fetch(`/api/afks/${afkId}/stop`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(result.message, 'warning');
                    loadAFKs();
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('AFK durdurma hatasƒ±: ' + error.message, 'error');
            }
        }

        async function deleteAFK(afkId, username) {
            if (confirm(`${username} AFK'sƒ±nƒ± silmek istediƒüinizden emin misiniz?`)) {
                try {
                    const response = await fetch(`/api/afks/${afkId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog(result.message, 'warning');
                        loadAFKs();
                    } else {
                        addLog(result.message, 'error');
                    }
                } catch (error) {
                    addLog('AFK silme hatasƒ±: ' + error.message, 'error');
                }
            }
        }

        async function saveWebhook() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!webhookUrl) {
                addLog('Webhook URL bo≈ü olamaz!', 'error');
                return;
            }

            try {
                const response = await fetch('/api/discord/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webhookUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(result.message, 'success');
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('Webhook kaydetme hatasƒ±: ' + error.message, 'error');
            }
        }

        async function saveNotificationWebhook() {
            const webhookUrl = document.getElementById('notificationWebhookUrl').value;
            
            if (!webhookUrl) {
                addLog('Bildirim webhook URL bo≈ü olamaz!', 'error');
                return;
            }

            try {
                const response = await fetch('/api/discord/notification-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ webhookUrl })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(result.message, 'success');
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('Bildirim webhook kaydetme hatasƒ±: ' + error.message, 'error');
            }
        }

        async function loadWebhook() {
            try {
                const response = await fetch('/api/discord/webhook');
                const data = await response.json();
                
                if (data.success) {
                    if (data.webhookUrl) {
                        document.getElementById('webhookUrl').value = data.webhookUrl;
                    }
                    if (data.notificationWebhookUrl) {
                        document.getElementById('notificationWebhookUrl').value = data.notificationWebhookUrl;
                    }
                }
            } catch (error) {
                console.error('Webhook y√ºkleme hatasƒ±:', error);
            }
        }

        // Chat Modal Fonksiyonlarƒ±
        async function openChatModal(afkId, username) {
            currentChatAfkId = afkId;
            document.getElementById('chatModalTitle').textContent = `üí¨ ${username} - Chat`;
            document.getElementById('chatModal').classList.add('active');
            await loadChatMessages(afkId);
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentChatAfkId = null;
        }

        async function loadChatMessages(afkId) {
            try {
                const response = await fetch(`/api/afks/${afkId}/chat`);
                const data = await response.json();
                
                const chatContainer = document.getElementById('chatMessages');
                
                if (data.success && data.messages && data.messages.length > 0) {
                    chatContainer.innerHTML = '';
                    data.messages.forEach(msg => {
                        addChatMessageToUI(msg.message, msg.timestamp);
                    });
                } else {
                    chatContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <h3>Hen√ºz mesaj yok</h3>
                            <p>Sunucudan mesajlar burada g√∂r√ºnecek</p>
                        </div>
                    `;
                }
            } catch (error) {
                addLog('Chat mesajlarƒ± y√ºklenemedi: ' + error.message, 'error');
            }
        }

        function handleChatMessage(data) {
            // Eƒüer modal a√ßƒ±ksa ve doƒüru bot i√ßin mesajsa, mesajƒ± g√∂ster
            if (currentChatAfkId === data.afkId) {
                const chatContainer = document.getElementById('chatMessages');
                
                // Empty state varsa temizle
                if (chatContainer.querySelector('.empty-state')) {
                    chatContainer.innerHTML = '';
                }
                
                addChatMessageToUI(data.message, data.timestamp, data.sender);
            }
        }

        function addChatMessageToUI(message, timestamp, sender = 'server') {
            const chatContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const time = new Date(timestamp).toLocaleTimeString('tr-TR');
            
            messageDiv.innerHTML = `
                <div class="chat-timestamp">${time}</div>
                <div class="chat-text">${escapeHtml(message)}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendChatMessage() {
            if (!currentChatAfkId) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`/api/afks/${currentChatAfkId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    input.value = '';
                } else {
                    addLog(result.message, 'error');
                }
            } catch (error) {
                addLog('Mesaj g√∂nderilemedi: ' + error.message, 'error');
            }
        }



        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Bot durum g√ºncelleme fonksiyonlarƒ±
        function handleBotStatusUpdate(data) {
            // Sadece ilgili bot'un durumunu g√ºncelle
            updateBotStatusInUI(data.afkId, data.status, data);
        }

        function handleAllBotStatuses(statuses) {
            // T√ºm bot durumlarƒ±nƒ± g√ºncelle
            statuses.forEach(status => {
                updateBotStatusInUI(status.afkId, status.status, status);
            });
        }

        function updateBotStatusInUI(afkId, status, data = {}) {
            // DOM'da ilgili bot elemanƒ±nƒ± bul ve durumunu g√ºncelle
            const afkItems = document.querySelectorAll('.afk-item');
            afkItems.forEach(item => {
                const itemId = item.dataset.afkId;
                if (itemId === afkId) {
                    const statusBadge = item.querySelector('.status-badge');
                    const uptimeSpan = item.querySelector('.uptime');
                    const actionsDiv = item.querySelector('.afk-actions');
                    
                    if (statusBadge) {
                        if (status === 'connected') {
                            statusBadge.className = 'status-badge status-active';
                            statusBadge.textContent = 'üü¢ Aktif';
                            item.classList.add('active');
                            
                            // Uptime'ƒ± g√ºncelle veya olu≈ütur
                            if (!uptimeSpan) {
                                const newUptimeSpan = document.createElement('span');
                                newUptimeSpan.className = 'uptime';
                                statusBadge.parentNode.appendChild(newUptimeSpan);
                            }
                            
                            if (data.connectedAt) {
                                const uptimeMs = Date.now() - data.connectedAt;
                                const hours = Math.floor(uptimeMs / 3600000);
                                const minutes = Math.floor((uptimeMs % 3600000) / 60000);
                                const seconds = Math.floor((uptimeMs % 60000) / 1000);
                                const uptimeElement = item.querySelector('.uptime');
                                if (uptimeElement) {
                                    uptimeElement.textContent = `‚è±Ô∏è ${hours}s ${minutes}d ${seconds}s`;
                                }
                            }
                        } else if (status === 'connecting') {
                            statusBadge.className = 'status-badge status-connecting';
                            statusBadge.textContent = 'üü° Baƒülanƒ±yor';
                            item.classList.add('active');
                        } else if (status === 'login') {
                            statusBadge.className = 'status-badge status-connecting';
                            statusBadge.textContent = 'üü° Login';
                            item.classList.add('active');
                        } else if (status === 'stopped' || status === 'disconnected') {
                            statusBadge.className = 'status-badge status-stopped';
                            statusBadge.textContent = 'üî¥ Kapalƒ±';
                            item.classList.remove('active');
                            
                            // Uptime'ƒ± temizle
                            if (uptimeSpan) {
                                uptimeSpan.textContent = '';
                            }
                        } else if (status === 'kicked' || status === 'error') {
                            statusBadge.className = 'status-badge status-stopped';
                            statusBadge.textContent = 'üî¥ Hata';
                            item.classList.remove('active');
                            
                            if (uptimeSpan) {
                                uptimeSpan.textContent = '';
                            }
                        }
                    }
                    
                    // Butonlarƒ± g√ºncelle (aktif/pasif durumuna g√∂re)
                    if (actionsDiv && status) {
                        const afkUsername = item.querySelector('h3').textContent.replace('ü§ñ ', '');
                        if (status === 'connected' || status === 'connecting' || status === 'login') {
                            actionsDiv.innerHTML = `
                                <button class="btn btn-danger btn-small" onclick="stopAFK('${afkId}')">Durdur</button>
                                <button class="btn btn-secondary btn-small" onclick="openChatModal('${afkId}', '${afkUsername}')">üí¨ Chat</button>
                                <button class="btn btn-warning btn-small" onclick="deleteAFK('${afkId}', '${afkUsername}')">Sil</button>
                            `;
                        } else {
                            actionsDiv.innerHTML = `
                                <button class="btn btn-primary btn-small" onclick="startAFK('${afkId}')">Ba≈ülat</button>
                                <button class="btn btn-warning btn-small" onclick="deleteAFK('${afkId}', '${afkUsername}')">Sil</button>
                            `;
                        }
                    }
                }
            });
        }

        // Sayfa y√ºklendiƒüinde
        window.addEventListener('load', () => {
            loadUserInfo();
            connectWebSocket();
            loadAFKs();
            loadWebhook();
            
            // Her 5 saniyede bir AFK listesini g√ºncelle
            setInterval(loadAFKs, 5000);
        });

        // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
        window.onclick = function(event) {
            const modal = document.getElementById('chatModal');
            if (event.target === modal) {
                closeChatModal();
            }
        }
    </script>
</body>
</html>
